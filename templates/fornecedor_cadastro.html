{% extends 'base_admin.html' %}

{% block content %}
<div class="form-container">
    <h2>Cadastro de Fornecedor</h2>
    <form action="#" method="post" enctype="multipart/form-data">
        <div class="form-group-half">
            <div class="form-group">
                <input type="text" id="fornecedor" name="fornecedor" required placeholder=" " maxlength="250">
                <label for="fornecedor">Empresa</label>
            </div>
            <div class="form-group">
                <input type="text" id="representante" name="representante" required placeholder=" " maxlength="250">
                <label for="representante">Representante</label>
            </div>
        </div>
        <div class="form-group-half">
            <div class="form-group">
                <input type="tel" id="telefone_representante" name="telefone_representante" maxlength="15 "
                    placeholder=" " onkeyup="handlePhone(event)" required>
                <label for="telefone_representante">Telefone do Representante</label>
            </div>
            <div class="form-group">
                <input type="text" id="cnpj" name="cnpj" placeholder=" ">
                <label for="cnpj">CNPJ</label>
            </div>
        </div><div class="divider"></div>

        <div class="form-group-half">
            <div class="form-group">
                <input type="text" id="cep" name="cep" maxlength="9" required placeholder=" " onkeyup="handleCEP(event)">
                <label for="cep">CEP</label>
            </div>
            <div class="form-group">
                <input type="text" id="logradouro" name="logradouro" maxlength="250" required placeholder=" ">
                <label for="logradouro">Logradouro</label>
            </div>
        </div>

        <div class="form-group-half">
            <div class="form-group">
                <input type="number" id="numero" name="numero" required placeholder=" ">
                <label for="numero">Número</label>
            </div>
            <div class="form-group">
                <input type="text" id="bairro" name="bairro" maxlength="250" required placeholder=" ">
                <label for="bairro">Bairro</label>
            </div>
        </div>

        <div class="form-group-half">
            <div class="form-group">
                <input type="text" id="complemento" name="complemento" maxlength="250" placeholder=" ">
                <label for="complemento">Complemento</label>
            </div>
            <div class="form-group">
                <input type="text" id="estado" name="estado" maxlength="2" required placeholder=" ">
                <label for="estado">Estado</label>
            </div>
        </div>

        <div class="form-group-half">
            <div class="form-group">
                <input type="text" id="cidade" name="cidade" maxlength="250" required placeholder=" ">
                <label for="cidade">Cidade</label>
            </div>
            <div class="form-group">
                <input type="text" id="telefone" name="telefone" maxlength="15" required placeholder=" "
                    onkeyup="handlePhone(event)">
                <label for="telefone">Telefone</label>
            </div>
        </div>


        <div class="container-btn-cadastrar">
            <button type="submit" class="btn-cadastrar">Cadastrar</button>
        </div>
    </form>
</div>

<script>
    const handlePhone = (event) => {
        let input = event.target
        input.value = phoneMask(input.value)
    }

    const phoneMask = (value) => {
        if (!value) return ""
        value = value.replace(/\D/g, '')
        value = value.replace(/(\d{2})(\d)/, "($1) $2")
        value = value.replace(/(\d)(\d{4})$/, "$1-$2")
        return value
    }

    document.getElementById('cnpj').addEventListener('input', function (e) {
        var value = e.target.value;
        var rawValue = value.replace(/\D/g, ''); // Remove tudo que não é número

        // Verifica se o CNPJ tem 15 dígitos e se o primeiro dígito é '0'
        if (rawValue.length === 15 && rawValue.startsWith('0')) {
            // Verifica se, ao remover o '0', o restante é um CNPJ válido
            var potentialCNPJ = rawValue.substring(1);
            // Atualiza rawValue para o CNPJ sem o '0' inicial
            if (validaCNPJ(potentialCNPJ)) rawValue = potentialCNPJ;
        }

        var cnpjPattern = rawValue
            .replace(/^(\d{2})(\d)/, '$1.$2') // Adiciona ponto após o segundo dígito
            .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3') // Adiciona ponto após o quinto dígito
            .replace(/\.(\d{3})(\d)/, '.$1/$2') // Adiciona barra após o oitavo dígito
            .replace(/(\d{4})(\d)/, '$1-$2') // Adiciona traço após o décimo segundo dígito
            .replace(/(-\d{2})\d+?$/, '$1'); // Impede a entrada de mais de 14 dígitos
        e.target.value = cnpjPattern;
    });


    /*Validador de endereco*/
    document.getElementById('cep').addEventListener('blur', function () {
        let cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro;
                        document.getElementById('cidade').value = data.localidade;
                        document.getElementById('estado').value = data.uf;
                    } else {
                        alert('CEP não encontrado.');
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar CEP:', error);
                    alert('Erro ao buscar CEP.');
                });
        } else {
            alert('CEP inválido.');
        }
    });

    const handleCEP = (event) => {
        let input = event.target;
        input.value = cepMask(input.value);
    }

    const cepMask = (value) => {
        if (!value) return "";
        value = value.replace(/\D/g, '');          // Remove tudo o que não é dígito
        value = value.replace(/(\d{5})(\d)/, "$1-$2"); // Adiciona o hífen entre o quinto e sexto dígito
        return value;
    }

    document.getElementById('enderecoForm').addEventListener('submit', function (event) {
        event.preventDefault();

        let cep = document.getElementById('cep').value;
        let logradouro = document.getElementById('logradouro').value;
        let numero = document.getElementById('numero').value;
        let bairro = document.getElementById('bairro').value;
        let complemento = document.getElementById('complemento').value;
        let estado = document.getElementById('estado').value;
        let cidade = document.getElementById('cidade').value;
        let telefone = document.getElementById('telefone').value;

        // Validações básicas
        if (!cep.match(/^\d{5}-\d{3}$/)) {
            alert('CEP inválido. Formato esperado: 00000-000');
            return;
        }

        if (estado.length !== 2) {
            alert('Estado deve ter 2 caracteres.');
            return;
        }

        if (!telefone.match(/^\(\d{2}\) \d{4,5}-\d{4}$/)) {
            alert('Telefone inválido. Formato esperado: (00) 0000-0000 ou (00) 00000-0000');
            return;
        }

        // Se todas as validações passarem, submete o formulário
        alert('Formulário enviado com sucesso!');
        // Aqui você pode enviar o formulário via AJAX ou processá-lo conforme necessário
    });



</script>
{% endblock %}